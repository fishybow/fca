name: Build Windows EXEs

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      build_arm64:
        description: Build windows-arm64 on self-hosted runner
        required: false
        type: boolean
        default: false

jobs:
  build-windows-x64:
    name: Build (windows-x64)
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build dependencies
        working-directory: python
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-build.txt

      - name: Run parity smoke test
        working-directory: python
        run: |
          python -m unittest tests.test_fca_unittest.TestFCAToolParity.test_tool_encode_decode_matches_standalone -v

      - name: Materialize icon from fca_tool embedded data
        working-directory: python
        run: |
          python fca_tool.py --export-icon .build-icon.ico

      - name: Debug build inputs
        working-directory: python
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "Working directory: $(Get-Location)"
          Write-Host "Python:"
          python --version
          Write-Host "Top-level python directory contents:"
          Get-ChildItem -Force | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
          if (!(Test-Path .build-icon.ico)) {
            throw "Missing .build-icon.ico before PyInstaller build"
          }
          Write-Host "Icon file metadata:"
          Get-Item .build-icon.ico | Select-Object FullName, Length, LastWriteTime | Format-List
          Write-Host "Icon SHA256:"
          Get-FileHash .build-icon.ico -Algorithm SHA256 | Format-List

      - name: Build executables (verbose)
        working-directory: python
        run: |
          $ErrorActionPreference = 'Stop'

          Write-Host "Running: python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-encode --distpath ../dist/windows-x64 fca_encode.py"
          & python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-encode --distpath ../dist/windows-x64 fca_encode.py 2>&1 | Tee-Object -FilePath pyinstaller-fca-encode.log
          if ($LASTEXITCODE -ne 0) { throw "PyInstaller failed for fca-encode" }

          Write-Host "Running: python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-decode --distpath ../dist/windows-x64 fca_decode.py"
          & python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-decode --distpath ../dist/windows-x64 fca_decode.py 2>&1 | Tee-Object -FilePath pyinstaller-fca-decode.log
          if ($LASTEXITCODE -ne 0) { throw "PyInstaller failed for fca-decode" }

          Write-Host "Running: python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-tool --distpath ../dist/windows-x64 fca_tool.py"
          & python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-tool --distpath ../dist/windows-x64 fca_tool.py 2>&1 | Tee-Object -FilePath pyinstaller-fca-tool.log
          if ($LASTEXITCODE -ne 0) { throw "PyInstaller failed for fca-tool" }

          Write-Host "Built files:"
          Get-ChildItem ../dist/windows-x64 -File | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize

      - name: Upload debug logs (x64)
        uses: actions/upload-artifact@v4
        with:
          name: fca-build-debug-windows-x64
          path: |
            python/.build-icon.ico
            python/pyinstaller-*.log
            python/*.spec
            python/build/**/warn-*.txt
          if-no-files-found: warn

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fca-exes-windows-x64
          path: |
            dist/windows-x64/fca-encode.exe
            dist/windows-x64/fca-decode.exe
            dist/windows-x64/fca-tool.exe
          if-no-files-found: error

  build-windows-arm64:
    name: Build (windows-arm64)
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_arm64 == true }}
    runs-on: [self-hosted, Windows, ARM64]
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build dependencies
        working-directory: python
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-build.txt

      - name: Run parity smoke test
        working-directory: python
        run: |
          python -m unittest tests.test_fca_unittest.TestFCAToolParity.test_tool_encode_decode_matches_standalone -v

      - name: Materialize icon from fca_tool embedded data
        working-directory: python
        run: |
          python fca_tool.py --export-icon .build-icon.ico

      - name: Debug build inputs
        working-directory: python
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "Working directory: $(Get-Location)"
          Write-Host "Python:"
          python --version
          Write-Host "Top-level python directory contents:"
          Get-ChildItem -Force | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
          if (!(Test-Path .build-icon.ico)) {
            throw "Missing .build-icon.ico before PyInstaller build"
          }
          Write-Host "Icon file metadata:"
          Get-Item .build-icon.ico | Select-Object FullName, Length, LastWriteTime | Format-List
          Write-Host "Icon SHA256:"
          Get-FileHash .build-icon.ico -Algorithm SHA256 | Format-List

      - name: Build executables (verbose)
        working-directory: python
        run: |
          $ErrorActionPreference = 'Stop'

          Write-Host "Running: python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-encode --distpath ../dist/windows-arm64 fca_encode.py"
          & python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-encode --distpath ../dist/windows-arm64 fca_encode.py 2>&1 | Tee-Object -FilePath pyinstaller-fca-encode.log
          if ($LASTEXITCODE -ne 0) { throw "PyInstaller failed for fca-encode" }

          Write-Host "Running: python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-decode --distpath ../dist/windows-arm64 fca_decode.py"
          & python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-decode --distpath ../dist/windows-arm64 fca_decode.py 2>&1 | Tee-Object -FilePath pyinstaller-fca-decode.log
          if ($LASTEXITCODE -ne 0) { throw "PyInstaller failed for fca-decode" }

          Write-Host "Running: python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-tool --distpath ../dist/windows-arm64 fca_tool.py"
          & python -m PyInstaller --clean --noconfirm --onefile --log-level DEBUG --icon .build-icon.ico --name fca-tool --distpath ../dist/windows-arm64 fca_tool.py 2>&1 | Tee-Object -FilePath pyinstaller-fca-tool.log
          if ($LASTEXITCODE -ne 0) { throw "PyInstaller failed for fca-tool" }

          Write-Host "Built files:"
          Get-ChildItem ../dist/windows-arm64 -File | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize

      - name: Upload debug logs (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: fca-build-debug-windows-arm64
          path: |
            python/.build-icon.ico
            python/pyinstaller-*.log
            python/*.spec
            python/build/**/warn-*.txt
          if-no-files-found: warn

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fca-exes-windows-arm64
          path: |
            dist/windows-arm64/fca-encode.exe
            dist/windows-arm64/fca-decode.exe
            dist/windows-arm64/fca-tool.exe
          if-no-files-found: error
